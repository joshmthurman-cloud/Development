{% extends "base.html" %}

{% block content %}
<div class="card" style="margin-bottom: 20px;">
    <h2>User Management</h2>
    <p>Manage user accounts, approve registrations, and assign merchant access.</p>
</div>

<!-- Pending Users Section -->
<div class="card" style="margin-bottom: 20px;">
    <h3 style="color: #e74c3c;">Pending Approval ({{ pending_users|length }})</h3>
    {% if pending_users %}
    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Registered</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in pending_users %}
            <tr>
                <td>{{ user.email }}</td>
                <td>{{ user.created_at }}</td>
                <td>
                    <button onclick="approveUser({{ user.id }}, '{{ user.email }}')" class="btn" style="background: #27ae60; padding: 6px 12px; font-size: 13px;">Approve</button>
                    <button onclick="deleteUser({{ user.id }}, '{{ user.email }}')" class="btn secondary" style="padding: 6px 12px; font-size: 13px;">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; padding: 20px;">No users pending approval.</p>
    {% endif %}
</div>

<!-- All Users Section -->
<div class="card">
    <h3>All Users ({{ all_users|length }})</h3>
    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Steam Access</th>
                <th>Merchants</th>
                <th>Registered</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in all_users %}
            <tr>
                <td><strong>{{ user.email }}</strong></td>
                <td>
                    {% if user.is_admin %}
                    <span style="color: #f39c12; font-weight: bold;">Admin</span>
                    {% else %}
                    User
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                    <span style="color: #27ae60; font-weight: bold;">Active</span>
                    {% else %}
                    <span style="color: #e74c3c;">Pending</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.can_view_steam %}
                    <span style="color: #27ae60;">Yes</span>
                    {% else %}
                    <span style="color: #666;">No</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_admin %}
                    <span style="color: #3498db;">All Merchants</span>
                    {% elif user.merchant_codes %}
                    <span style="font-size: 12px;">{{ user.merchant_codes|join(', ') }}</span>
                    {% else %}
                    <span style="color: #666;">None</span>
                    {% endif %}
                </td>
                <td style="font-size: 12px;">{{ user.created_at }}</td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        {% if not user.is_active %}
                        <button onclick="approveUser({{ user.id }}, '{{ user.email }}')" class="btn" style="background: #27ae60; padding: 6px 12px; font-size: 12px;">Approve</button>
                        {% endif %}
                        <button onclick="editUser({{ user.id }}, '{{ user.email }}')" class="btn" style="background: #3498db; padding: 6px 12px; font-size: 12px;">Edit</button>
                        {% if not user.is_admin %}
                        <button onclick="deleteUser({{ user.id }}, '{{ user.email }}')" class="btn secondary" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Edit User Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative;">
        <button onclick="closeEditModal()" style="position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">X</button>
        <h3 id="editUserTitle">Edit User</h3>
        <form id="editUserForm" onsubmit="saveUser(event)">
            <input type="hidden" id="editUserId" name="user_id">
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email:</label>
                <input type="email" id="editUserEmail" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                    <input type="checkbox" id="editUserAdmin" name="is_admin"> Admin User
                </label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                    <input type="checkbox" id="editUserSteam" name="can_view_steam" onchange="updateSupportCheckbox()"> Can View Steam/Denovo
                </label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                    <input type="checkbox" id="editUserSupport" onchange="toggleSupportAccess()"> Support (Selects All Merchants & Steam/Denovo Access)
                </label>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Merchant Access:</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                    {% for merchant in merchants %}
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" name="merchants" value="{{ merchant.code }}" class="merchant-checkbox" onchange="updateSupportCheckbox()">
                        {{ merchant.display }}
                    </label>
                    {% endfor %}
                </div>
                <small style="color: #666;">Leave unchecked to give access to all merchants (admin only)</small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn" style="flex: 1;">Save Changes</button>
                <button type="button" onclick="closeEditModal()" class="btn secondary" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentEditingUserId = null;

async function approveUser(userId, email) {
    if (!confirm(`Approve user ${email}?`)) return;
    
    try {
        const response = await fetch(`/api/admin/approve-user/${userId}`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            alert(`User ${email} approved successfully!`);
            location.reload();
        } else {
            alert('Error: ' + (data.detail || 'Failed to approve user'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteUser(userId, email) {
    if (!confirm(`Delete user ${email}? This action cannot be undone.`)) return;
    
    try {
        const response = await fetch(`/api/admin/delete-user/${userId}`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            alert(`User ${email} deleted successfully!`);
            location.reload();
        } else {
            alert('Error: ' + (data.detail || 'Failed to delete user'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function editUser(userId, email) {
    currentEditingUserId = userId;
    document.getElementById('editUserId').value = userId;
    document.getElementById('editUserEmail').value = email;
    document.getElementById('editUserTitle').textContent = `Edit User: ${email}`;
    
    // Fetch user details
    fetch(`/api/admin/user/${userId}`)
        .then(response => response.json())
        .then(user => {
            document.getElementById('editUserAdmin').checked = user.is_admin || false;
            document.getElementById('editUserSteam').checked = user.can_view_steam || false;
            
            // Check merchant checkboxes
            const merchantCheckboxes = document.querySelectorAll('.merchant-checkbox');
            merchantCheckboxes.forEach(cb => {
                cb.checked = user.merchant_codes && user.merchant_codes.includes(cb.value);
            });
            
            // Check if Support should be checked (all merchants selected and Steam access enabled)
            const allMerchantsSelected = merchantCheckboxes.length > 0 && 
                Array.from(merchantCheckboxes).every(cb => cb.checked);
            const supportChecked = allMerchantsSelected && (user.can_view_steam || false);
            document.getElementById('editUserSupport').checked = supportChecked;
            
            document.getElementById('editModal').style.display = 'flex';
        })
        .catch(error => {
            alert('Error loading user details: ' + error.message);
        });
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingUserId = null;
}

function toggleSupportAccess() {
    const supportCheckbox = document.getElementById('editUserSupport');
    const steamCheckbox = document.getElementById('editUserSteam');
    const merchantCheckboxes = document.querySelectorAll('.merchant-checkbox');
    
    if (supportCheckbox.checked) {
        // Select all merchants
        merchantCheckboxes.forEach(cb => {
            cb.checked = true;
        });
        // Enable Steam/Denovo access
        steamCheckbox.checked = true;
    } else {
        // Uncheck all merchants
        merchantCheckboxes.forEach(cb => {
            cb.checked = false;
        });
        // Disable Steam/Denovo access
        steamCheckbox.checked = false;
    }
}

function updateSupportCheckbox() {
    const supportCheckbox = document.getElementById('editUserSupport');
    const steamCheckbox = document.getElementById('editUserSteam');
    const merchantCheckboxes = document.querySelectorAll('.merchant-checkbox');
    
    // Check if all merchants are selected and Steam access is enabled
    const allMerchantsSelected = merchantCheckboxes.length > 0 && 
        Array.from(merchantCheckboxes).every(cb => cb.checked);
    const steamEnabled = steamCheckbox.checked;
    
    // Update Support checkbox to reflect current state
    supportCheckbox.checked = allMerchantsSelected && steamEnabled;
}

async function saveUser(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const userId = formData.get('user_id');
    const isAdmin = formData.get('is_admin') === 'on';
    const canViewSteam = formData.get('can_view_steam') === 'on';
    const selectedMerchants = Array.from(document.querySelectorAll('.merchant-checkbox:checked')).map(cb => cb.value);
    
    try {
        // Update user basic info
        const updateResponse = await fetch(`/api/admin/update-user/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                is_admin: isAdmin,
                can_view_steam: canViewSteam
            })
        });
        
        if (!updateResponse.ok) {
            const error = await updateResponse.json();
            throw new Error(error.detail || 'Failed to update user');
        }
        
        // Update merchant assignments
        if (!isAdmin) {
            const merchantResponse = await fetch(`/api/admin/assign-merchants/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selectedMerchants)
            });
            
            if (!merchantResponse.ok) {
                const error = await merchantResponse.json();
                throw new Error(error.detail || 'Failed to assign merchants');
            }
        }
        
        alert('User updated successfully!');
        closeEditModal();
        location.reload();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}

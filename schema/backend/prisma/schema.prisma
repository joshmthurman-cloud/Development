generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Authentication & Users ────────────────────────────────────────────────────

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  memberships   BusinessMember[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique
  userId    String    @map("user_id") @db.Uuid
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ─── Multi-Tenancy ─────────────────────────────────────────────────────────────

model Business {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members     BusinessMember[]
  fiscalYears FiscalYear[]
  categories  Category[]
  templates   Template[]
  auditLogs   AuditLog[]

  @@map("businesses")
}

model BusinessMember {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  businessId String   @map("business_id") @db.Uuid
  role       Role     @default(VIEWER)
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@map("business_members")
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

// ─── Fiscal Year ───────────────────────────────────────────────────────────────

model FiscalYear {
  id            String   @id @default(uuid()) @db.Uuid
  businessId    String   @map("business_id") @db.Uuid
  year          Int
  carryover     Decimal? @db.Decimal(12, 2)
  mileageDriven Int?     @map("mileage_driven")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  ledgerEntries LedgerEntry[]
  revisions     Revision[]
  officeInHome  OfficeInHome?
  fixedAssets   FixedAsset[]

  @@unique([businessId, year])
  @@map("fiscal_years")
}

// ─── Categories (derived from Excel template) ──────────────────────────────────

enum AccountType {
  BANK
  CREDIT_CARD
  PERSONALLY_PAID
}

enum CategoryGroup {
  INCOME
  OTHER_SOURCE_OF_FUNDS
  DISTRIBUTION
  RETURNS_ALLOWANCES
  CONTRACT_LABOR
  FIXED_ASSET_PURCHASE
  OPERATING_EXPENSE
  PENALTY
  INTEREST_EXPENSE
  CREDIT_CARD_PAYMENT
}

model Category {
  id         String        @id @default(uuid()) @db.Uuid
  businessId String        @map("business_id") @db.Uuid
  name       String
  group      CategoryGroup
  parentId   String?       @map("parent_id") @db.Uuid
  sortOrder  Int           @default(0) @map("sort_order")
  isActive   Boolean       @default(true) @map("is_active")
  createdAt  DateTime      @default(now()) @map("created_at")

  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent        Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[]    @relation("CategoryHierarchy")
  ledgerEntries LedgerEntry[]

  @@unique([businessId, name, parentId])
  @@map("categories")
}

// ─── Immutable Ledger ──────────────────────────────────────────────────────────

model LedgerEntry {
  id           String      @id @default(uuid()) @db.Uuid
  fiscalYearId String      @map("fiscal_year_id") @db.Uuid
  categoryId   String      @map("category_id") @db.Uuid
  accountType  AccountType @map("account_type")
  month        Int // 1–12
  amount       Decimal     @db.Decimal(12, 2)
  description  String?
  revisionId   String?     @map("revision_id") @db.Uuid
  reversedById String?     @unique @map("reversed_by_id") @db.Uuid
  createdAt    DateTime    @default(now()) @map("created_at")
  createdBy    String      @map("created_by") @db.Uuid

  fiscalYear FiscalYear   @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  category   Category     @relation(fields: [categoryId], references: [id])
  revision   Revision?    @relation(fields: [revisionId], references: [id])
  reversedBy LedgerEntry? @relation("ReversalChain", fields: [reversedById], references: [id])
  reverses   LedgerEntry? @relation("ReversalChain")
  receipts   Receipt[]

  @@index([fiscalYearId, accountType, month])
  @@index([categoryId])
  @@map("ledger_entries")
}

// ─── Revision Control (3 rollback points + current head) ───────────────────────

model Revision {
  id             String   @id @default(uuid()) @db.Uuid
  fiscalYearId   String   @map("fiscal_year_id") @db.Uuid
  revisionNumber Int      @map("revision_number")
  description    String?
  snapshotData   Json     @map("snapshot_data")
  createdAt      DateTime @default(now()) @map("created_at")
  createdBy      String   @map("created_by") @db.Uuid

  fiscalYear FiscalYear    @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  entries    LedgerEntry[]

  @@unique([fiscalYearId, revisionNumber])
  @@map("revisions")
}

// ─── Receipts & File Storage ───────────────────────────────────────────────────

enum ScanStatus {
  PENDING
  CLEAN
  INFECTED
  ERROR
}

enum OcrStatus {
  PENDING
  COMPLETED
  FAILED
}

model Receipt {
  id                String     @id @default(uuid()) @db.Uuid
  ledgerEntryId     String?    @map("ledger_entry_id") @db.Uuid
  businessId        String     @map("business_id") @db.Uuid
  originalFilename  String     @map("original_filename")
  storageKey        String     @map("storage_key")
  mimeType          String     @map("mime_type")
  fileSize          Int        @map("file_size")
  malwareScanStatus ScanStatus @default(PENDING) @map("malware_scan_status")
  ocrText           String?    @map("ocr_text")
  ocrStatus         OcrStatus  @default(PENDING) @map("ocr_status")
  uploadedBy        String     @map("uploaded_by") @db.Uuid
  createdAt         DateTime   @default(now()) @map("created_at")

  ledgerEntry LedgerEntry? @relation(fields: [ledgerEntryId], references: [id])

  @@index([businessId])
  @@map("receipts")
}

// ─── Templates ─────────────────────────────────────────────────────────────────

model Template {
  id               String   @id @default(uuid()) @db.Uuid
  businessId       String   @map("business_id") @db.Uuid
  originalFilename String   @map("original_filename")
  storageKey       String   @map("storage_key")
  parsedSchema     Json     @map("parsed_schema")
  uploadedBy       String   @map("uploaded_by") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("templates")
}

// ─── Office in Home ────────────────────────────────────────────────────────────

model OfficeInHome {
  id                  String   @id @default(uuid()) @db.Uuid
  fiscalYearId        String   @unique @map("fiscal_year_id") @db.Uuid
  officeSquareFootage Decimal? @map("office_square_footage") @db.Decimal(10, 2)
  totalSquareFootage  Decimal? @map("total_square_footage") @db.Decimal(10, 2)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  fiscalYear FiscalYear            @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  expenses   OfficeInHomeExpense[]

  @@map("office_in_home")
}

model OfficeInHomeExpense {
  id             String   @id @default(uuid()) @db.Uuid
  officeInHomeId String   @map("office_in_home_id") @db.Uuid
  category       String // Internet, Gas, Electric, Water, etc.
  month          Int // 1–12
  amount         Decimal  @db.Decimal(12, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  officeInHome OfficeInHome @relation(fields: [officeInHomeId], references: [id], onDelete: Cascade)

  @@unique([officeInHomeId, category, month])
  @@map("office_in_home_expenses")
}

// ─── Fixed Assets ──────────────────────────────────────────────────────────────

model FixedAsset {
  id           String   @id @default(uuid()) @db.Uuid
  fiscalYearId String   @map("fiscal_year_id") @db.Uuid
  purchaseDate DateTime @map("purchase_date")
  description  String
  amountPaid   Decimal  @map("amount_paid") @db.Decimal(12, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  fiscalYear FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)

  @@map("fixed_assets")
}

// ─── Audit Log ─────────────────────────────────────────────────────────────────

model AuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  correlationId String   @map("correlation_id")
  userId        String?  @map("user_id") @db.Uuid
  businessId    String?  @map("business_id") @db.Uuid
  action        String
  entityType    String   @map("entity_type")
  entityId      String?  @map("entity_id")
  beforeState   Json?    @map("before_state")
  afterState    Json?    @map("after_state")
  metadata      Json?
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")

  user     User?     @relation(fields: [userId], references: [id])
  business Business? @relation(fields: [businessId], references: [id])

  @@index([correlationId])
  @@index([userId])
  @@index([businessId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
